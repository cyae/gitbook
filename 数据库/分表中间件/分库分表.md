---
date created: 2023-03-08 19:22
---

#数据存储

业务增长到一定量级时，单表读写性能急剧下降，无法支撑业务发展。

## 垂直拆分

- 根据**业务维度**做表的划分，这个最常见的，在微服务拆分、数据模型设计时就会考虑，不做具体介绍。

## 水平拆分

- 根据**某个字段**（即分库/分表因子）应用某种策略来做拆分，达到平摊压力的目的。

- 使用分库分表后会遇到一些挑战：
  - 分布式事务。对多个数据库有事务控制，可能会引发更严重的性能问题。
  - 跨库查询、统计、排序。查询次数放大、内存合并引发 OOM。
  - 数据倾斜。热点数据未被有效拆分。

## 水平拆分策略

| 策略        | 思想                                                                                             | 优点                                     | 缺点                                 |
| ----------- | ------------------------------------------------------------------------------------------------ | ---------------------------------------- | ------------------------------------ |
| hash        | 计算分库下标公式：hash(分库因子)%分库数                                                          | 简单                                     | 数据库扩容后数据迁移困难             |
| 一致性 hash | 部分解决 hash 算法在新增、减少数据库节点时的数据迁移问题。使用一个 hash 环来管理分库因子映射范围 | 新增、删除数据库节点后，需要迁移的数据少 | 存在数据倾斜的可能                   |
| 字典表      | 全局数据具备同一种属性，以其作为分库因子实现分库                                                 | 平滑扩容，无数据迁移成本；能避免跨库事务 | 字典表容易形成瓶颈；容易出现数据倾斜 |
| 业务索引表  | 每张表根据实际情况选择分库因子做 sharding                                                        | 数据分布均匀                             | 容易出现跨库事务问题                 |

使用何种策略？有几个原则可参考：

- 数据尽可能均匀分布。数据不均匀分布的话，分库分表的效果就要打折扣，因为很快热点数据又会发生性能瓶颈。
- 运维代价可控。数据库多了，运维成本是需要考虑的。
- 尽量避免跨库事务。跨库事务既是添加了实现复杂度，又加大了锁冲突概率，可能引发更严重的性能问题。

## 技术选型

---

### 客户端分库分表

优点：

- 未引入中间件，没有运维成本
- 业务与数据库直连，未增加 RT 成本

缺点：

- 业务发展到一定阶段，业务微服务实例数变多后，数据库连接数会是瓶颈
- 问题定位、数据治理较困难

常见技术选型：

- sharding-jdbc。当当开源，现在是 apache 顶级项目，发展较成熟，目前社区仍在快速迭代。

### proxy 分库分表

优点：

- 无数据库连接数瓶颈
- 支持异构语言

缺点：

- 存在访问热点
- 数据库访问 RT 会加大

常见技术选型：

- cobar。阿里开源，mycat、TDDL 等都基于它发展而来，目前社区已不活跃，不建议选型。
- mycat。纯社区运作，目前活跃度一般，不建议选型。
- sharding-proxy。sharding-jdbc 的 proxy 版本，版本成熟度不够，谨慎选型。
- Atlas。360 开源，从 mysql proxy 发展而来
- DDM。华为云提供的云服务，从 mycat 发展而来
- DRDS。阿里云提供的云服务，基于 TDDL 演进而来。

### 服务端分库分表

nosql

mongodb、cassandra

nosql 一般是 AP 型设计，很少会追求强一致性，所以分区能力基本不是问题，但是若业务有强一致性要求，则这条路不适合。

newsql

tidb

优点：

- 新一代数据库，既有关系型数据库的 ACID 特性，又有 nosql 的水平扩展能力。目前社区活跃，值得研究。

缺点：

- 需要自行维护环境。
- 新事物，未被广泛证明。需要有尝鲜的勇气。

### 引申

数据库的 sharding 思想同样可应用在系统层面，比如：

- MPP 架构
- SET 化技术
- share-nothing 架构

## 分布式 ID 生成器

---

使用分库分表后，自增主键之类的东西是没法使用了，否则容易给业务挖坑。

目前主要有两种实现思路：

**redis**
使用 incr 命令，可保证数据的全局自增、原子

优点：简单

缺点：存在访问热点

**雪花算法**
该算法的思想是：为所有参与计算 ID 的进程分配单独区间，保证 ID 永不重复。

该算法不存在访问热点，只要保证各进程分配不同的区间，性能没有瓶颈。

优点：性能高，无热点

缺点：生成的 ID 不连续

**选型建议**
若追求 ID 连续性，则使用 redis，否则使用雪花算法。
