
从入口main函数开始找, 一般来说的核心流程包括: 载入配置, 初始化资源, 载入状态(load save), 开启主循环, 销毁资源

![[Pasted image 20230119163048.png]]

## 1. 启动流程

> 初始化核心概念中的RedisServer为空值
![[Pasted image 20230119161725.png]]

> 给RedisServer的eventloop赋初值. 注册一个acceptHandler用于接收request, 并通过头插法插入eventloop
![[Pasted image 20230119164004.png]]

> ae调用者: main函数的aeMain
![[Pasted image 20230119164308.png]]

## 2. 请求处理流程

> ae工作内容: 接收request -> handler操作dict -> 发送reply, RedisObj


> 监听回调函数acceptHandler用于监听新的client建立连接, 并为其分配文件句柄cfd
![[Pasted image 20230119165120.png]]

> RedisClient拿到cfd后创建客户端, 其中向server的eventloop里注册回调函数readQueryFromClient, 用于听取客户端指令
![[Pasted image 20230119165616.png]]

> 在readQueryFromClient回调函数中使用系统调用read, 将buffer中的命令读入client的argv/argc, 一边读入一边执行命令
![[Pasted image 20230119172301.png]]

> 执行命令函数processCommand会先根据argv里的命令关键字, 查询具体执行函数参数个数flag等, 然后调用具体执行函数`proc`. 
> 
> 也涉及主从路由等附加功能
![[Pasted image 20230119172727.png]]

> 以get命令的具体执行函数为例: 去RedisDB的dict里找argv参数里的目标key对应的value, 找到则添加到client的reply
![[Pasted image 20230119173332.png]]

> 具体的添加reply方式: 向server的eventloop中注册写函数sendReplyToClient
![[Pasted image 20230119173515.png]]

> 在sendReplyToClient回调函数中使用系统调用write, 将查询结果RedisObj写入client的回复链表reply
![[Pasted image 20230119173850.png]]



