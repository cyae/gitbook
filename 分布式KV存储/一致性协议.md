## 分布式架构的问题

分布式系统中，如果要**确认一个节点是否工作正常**，最直观的处理方法是在**每个副本与主副本维护一个心跳**，**期望通过心跳是否存在**而判断对方是否依旧存活。

**在实际使用过程中,心跳方法其实根本无法解决分布式下节点是否正常的这个的这个问题。**

1. 在某个时刻 Node1 主节点突然出现**网络抖动**或者**网络中断**情况(注意:**不是宕机**),导致从节点无法接受到心跳.。

![](https://pic1.zhimg.com/80/v2-b31a2b7c8c04bb1ae7bcce4d854ad7bc_720w.webp)

2. **会在剩下的副节点中选取一当主节点。其实这个时候 Node1 并没有宕机**

![](https://pic1.zhimg.com/80/v2-20a1995b611c6c9aac11a9565e7896ac_720w.webp)

**上诉问题主要解决思路有四种**：

1. 设计能容忍双主的分布式协议。

2. Raft 协议-通过 Term 版本高的同步低的。

3. 用lease 机制。

4. 涉及去中心化-Gossip 协议。

## Lease 机制

Lease 机制，翻译过来即是**租约机制**，是一种在分布式系统常用的协议，是**维护分布式系统数据一致性**的一种常用**工具**。

**Lease 机制有以下几个特点：**

Lease 是颁发者对**一段时间内数据一致性的承诺**；

颁发者发出 Lease 后，不管是否被接收，只要**Lease 不过期**，颁发者都会**按照协议遵守承诺**；

Lease 的持有者只能在 Lease 的有效期内使用承诺，一旦**Lease 超时**，**持有者需要放弃执行**，重新**申请 Lease**。

**图例说明**

![](https://pic2.zhimg.com/80/v2-c1f2afc64aaa411b4eacc56110f1dcfd_720w.webp)



### Lease 的原理

1. 引入**中心节点负责下发 Lease。**

![](https://pic4.zhimg.com/80/v2-7b9adf53290dfb80f0b2ec20dbf31cc3_720w.webp)

**2. 出现网络问题或者宕机，其他机器选出主节点，主节点向中心节点申请 Lease，中心节点发现上一个还未过期，拒绝颁发。在 01:10 之前都会 承认有主节点。因此不会颁发。**

![](https://pic1.zhimg.com/80/v2-1e1544e23bb54156d7bd6674e89b82b8_720w.webp)

**3. 如果网络恢复**

![](https://pic2.zhimg.com/80/v2-55c833f6d554fe0f5d47f8fd7abd1225_720w.webp)

**4. 如果到 01:10 时间,主节点没有宕机或者网络问题，会进行续约操作,然后在下发新的 Lease**

![](https://pic4.zhimg.com/80/v2-37b4612d08de7a28baf58e65e0c90eab_720w.webp)

**5. 如果到 01:10 时间，主节点宕机，副节点申请 Lease,申请成功. 因为 Lease 过期 。**

![](https://pic1.zhimg.com/80/v2-859a1b0b33780265633616ac32a10b30_720w.webp)

### Lease 的容错

**1. 主节点宕机**

> lease 机制天生即可容忍网络、lease 接收方的出错,时间即 Lease 剩余过期时长

**2. 中心节点异常**

> 颁发者宕机可能使得全部节点没有 lease，系统处于不可用状态，解决的方法就是使用一个小集群而不是单一节点作为颁发者。

**3. 时差问题**

> 中心节点与主节点之间的时钟可能也存在误差，只需要中心节点考虑时钟误差即可。

### 建议

**lease 时间长短一般取经验值 1-10 秒即可。太短网络压力大，太长则收回承诺时间过长影响可用性。**

## RAFT 协议

见[[RAFT]]
